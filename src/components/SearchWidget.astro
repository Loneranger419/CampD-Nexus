---
import { withBase } from '../utils/paths';

const pagefindScript = withBase('/pagefind/pagefind-ui.js');
const pagefindAssets = withBase('/pagefind/');
---

<div class="relative">
	<button
		type="button"
		class="btn-secondary hidden h-10 items-center gap-2 rounded-full px-4 text-sm font-semibold md:inline-flex"
		data-search-open
	>
		<svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" aria-hidden="true">
			<path
				fill="currentColor"
				d="M10 3a7 7 0 0 1 5.61 11.17l4.11 4.11a1 1 0 0 1-1.42 1.42l-4.11-4.11A7 7 0 1 1 10 3Zm0 2a5 5 0 1 0 0 10a5 5 0 0 0 0-10Z"
			/>
		</svg>
		<span>Search</span>
		<span class="rounded-full bg-border/60 px-2 py-0.5 text-[0.65rem] uppercase tracking-wide text-muted md:inline">
			Ctrl&nbsp;K
		</span>
	</button>
	<dialog id="campd-search" class="search-dialog">
		<form method="dialog">
			<button
				type="submit"
				data-search-close
				class="absolute right-4 top-4 rounded-full border border-border/60 bg-background/70 px-3 py-1 text-xs uppercase tracking-wide text-muted transition hover:border-accent/60 hover:text-accent"
			>
				Close
			</button>
		</form>
		<div class="search-shell">
			<div id="pagefind-search" class="search-panel"></div>
		</div>
	</dialog>
</div>

<style>
	.search-dialog::backdrop {
		background-color: rgba(8, 11, 20, 0.65);
		backdrop-filter: blur(6px);
	}
	.search-dialog {
		border: none;
		border-radius: var(--tile-radius);
		padding: 0;
		width: min(880px, 90vw);
		background: transparent;
	}
	.search-shell {
		background: color-mix(in srgb, var(--surface) 85%, transparent);
		border: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
		border-radius: var(--tile-radius);
		box-shadow: 0 18px 35px rgba(0, 0, 0, 0.25);
		padding: 1.75rem 2rem;
	}
	.search-panel {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}
	:global(.pagefind-ui__result) {
		display: flex;
		flex-direction: column;
		gap: 0.35rem;
		padding: 1rem 1.25rem;
		border-radius: calc(var(--tile-radius) - 6px);
		border: 1px solid color-mix(in srgb, var(--border) 40%, transparent);
		background: color-mix(in srgb, var(--background) 80%, transparent);
		transition: border-color 120ms ease, background-color 120ms ease;
	}
	:global(.pagefind-ui__result:hover) {
		border-color: color-mix(in srgb, var(--accent) 60%, transparent);
		background: color-mix(in srgb, var(--surface) 88%, transparent);
	}
	:global(.pagefind-ui__result-title) {
		font-size: 1rem;
		font-weight: 600;
		color: var(--foreground);
	}
	:global(.pagefind-ui__result-excerpt) {
		color: var(--muted);
		font-size: 0.875rem;
	}
	:global(.pagefind-ui__result-link) {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: color-mix(in srgb, var(--accent) 85%, white 15%);
		font-weight: 600;
	}
	:global(.pagefind-ui__form) {
		background: color-mix(in srgb, var(--background) 90%, transparent);
		border: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
		border-radius: calc(var(--tile-radius) - 4px);
		padding: 0.85rem 1rem;
		box-shadow: inset 0 0 0 1px color-mix(in srgb, transparent 85%, var(--border) 15%);
	}
	:global(.pagefind-ui__form input) {
		font-size: 0.95rem;
		color: var(--foreground);
	}
</style>

<script>
	const pagefindOptions = {
		showImages: false,
		baseUrl: "${pagefindAssets}",
		bundlePath: "${pagefindAssets}"
	};
	const pagefindScriptUrl = "${pagefindScript}";

	(() => {
		const dialog = document.getElementById('campd-search');
		const openers = document.querySelectorAll('[data-search-open]');
		const closeButton = dialog?.querySelector('[data-search-close]');

		let pagefindScriptPromise = null;
		let pagefindInstance = null;
		let pagefindReady = false;

		const loadPagefindScript = () => {
			if (pagefindScriptPromise) return pagefindScriptPromise;

			pagefindScriptPromise = new Promise((resolve) => {
				const existing = document.querySelector('script[data-pagefind-ui]');
				if (existing) {
					if (existing.dataset.loaded === 'true') {
						resolve(true);
						return;
					}
					existing.addEventListener('load', () => resolve(true), { once: true });
					existing.addEventListener('error', () => resolve(false), { once: true });
					return;
				}

				const script = document.createElement('script');
				script.type = 'module';
				script.src = pagefindScriptUrl;
				script.dataset.pagefindUi = 'true';
				script.addEventListener('load', () => {
					script.dataset.loaded = 'true';
					resolve(true);
				});
				script.addEventListener('error', (error) => {
					console.error('Failed to load Pagefind UI script', error);
					resolve(false);
				});
				document.head.appendChild(script);
			});

			return pagefindScriptPromise;
		};

		const ensurePagefindReady = async () => {
			if (pagefindReady) return true;

			const loaded = await loadPagefindScript();
			if (!loaded) {
				return false;
			}

			const PagefindUIClass = window?.PagefindUI;
			if (typeof PagefindUIClass !== 'function') {
				console.error('Pagefind UI script loaded but window.PagefindUI is unavailable');
				return false;
			}

			const container = document.querySelector('#pagefind-search');
			if (!container) {
				console.error('Search container #pagefind-search not found');
				return false;
			}

			if (!pagefindInstance) {
				pagefindInstance = new PagefindUIClass({
					element: container,
					showImages: pagefindOptions.showImages,
					baseUrl: pagefindOptions.baseUrl,
					bundlePath: pagefindOptions.bundlePath,
					resetStyles: false
				});
			}

			pagefindReady = true;
			return true;
		};

		const openDialog = async () => {
			const ready = await ensurePagefindReady();
			if (!ready) {
				return;
			}

			dialog?.showModal();
			requestAnimationFrame(() => {
				const input = dialog?.querySelector('input');
				input?.focus();
				input?.select();
			});
		};

		openers.forEach((button) => {
			button.addEventListener('click', openDialog);
		});

		closeButton?.addEventListener('click', () => dialog?.close());

		dialog?.addEventListener('cancel', () => dialog.close());
		dialog?.addEventListener('click', (event) => {
			if (event.target === dialog) {
				dialog.close();
			}
		});

		const shortcutHandler = async (event) => {
			if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
				event.preventDefault();
				await openDialog();
			}
		};

		window.addEventListener('keydown', shortcutHandler);
	})();
</script>

